# 點對點網路協定

點對點網路協定是 以太坊 客戶端交換資訊的方式。在你筆電上執行的客戶端程式，會透過這樣的協定去找到其他的客戶端。所有交易、區塊的傳播，也是透過這個協定來進行。

（ p2p 網路示意圖）

節點透過 RLPx 傳輸加密過的訊息。 RLPx Node Discovery Protocol v4 節點發現協定。新版的 v5 已存在，但仍在實驗中，並沒有在主網路上使用。

這個協定的設計，從 2015 年以太坊上線以來沒怎麼變動過。目前（2018 年 4 月） {{"cryptoeprint:2018:236"|cite}} 是唯一詳細記載 p2p 行為的文件。本文內容主要也會是摘取自那篇論文。


### Kademlia 的異同

以太坊的點對點協定是修改 Kademlia DHT。Kademlia 原本是設計在點對點網路中，有效地找尋、儲存內容（例如文字、影片資源）。但在以太坊的應用中，只作為找尋新的節點使用。

在原來的 Kademlia 網路中，每個內容都有個相應總長 b 位元的鍵（ key），並儲存在所有 ID (也是 b 位元) 最「接近」的節點。所謂接近，是以 Kademlia 定義的距離而言：兩個 b 位元的 t1 與 t2 ，之間的距離為 t1 XOR t2 ，並將這個 XOR 的結果以整數詮釋。

```python
>>> t1 = int('00111100', 2)
>>> t2 = int('00001101', 2)
>>> t1^t2
49
```

節點會去找尋離想要的資源最近節點，問他們有沒有資源，或是最近的節點是什麼。如果沒有找到資源就一直問最近的節點，直到找到資源為止（或所有最近的節點都問完）。

在以太坊中，同樣也有 XOR 的距離單位。但以太訪節點不需要找尋儲存的資源，而是要找尋其他節點。客戶端一開始會產生一個隨機的 t ，在自己的桶子（bucket）中找尋 k=16 個 ID 最接近 t 的節點。接著再和那些節點訪問 k 個最接近 t 的節點。因此現在總共有  k*k 個節點了，再從中選 k 個，去和他們再問 k 個，直到沒有新的節點被發現。

### 節點身份

節點的 ID 是一個 b = 512 位元 （或 64 位元組）的橢圓曲線 ECDSA 公鑰。

一般節點以 `enode://{ID}@{IP}:{port}` 格式記載。如以下範例：

`enode://a979fb575495b8d6db44f750317d0f4622bf4c2aa3365d6af7c284339968eef29b69ad0dce72a4d8db5ebb4968de0e3bec910127f134779fbcb0cb6d3331163c@52.16.188.185:30303`

寫死在 Geth 客戶端中的種子節點

https://github.com/ethereum/go-ethereum/blob/master/params/bootnodes.go


### 網路連線

#### UDP 連線

UDP 用來交換點對點網路的資訊。用 UDP 交換的訊息有四種類別：

- 發起方發出 `ping` ，接收方回應 `pong`，這對主要用來偵測節點是否還有反應。 
- 發起方發出 `findnode`，接收方回應 `neighbor`，這是用來向詢問前述 16 個鄰近節點。

所有的 UDP 訊息都有加時間戳，並用發送者的 ECDSA 公鑰（也就是節點 ID）加密且認證過。為了避免重放攻擊，客戶端會丟棄任何相差本地時間 20 秒以上的訊息。為了避免偽造 IP 傳來的 `pong` ， `pong` 裡也要加上 `ping` 的雜湊值。

#### TCP 連線

所有「區塊鏈」的資訊則是透過 TCP 連線交換，也是加密、認證過的。客戶端可以設定 TCP 連線的總數上限 `maxpeers`，預設為 25 。

### 儲存網路資訊

客戶端會以兩種方式儲存其他節點的資訊。第一種是長期的資料庫 `db`，這會存在硬碟中，當客戶端重啟時資料不會消滅。第二種是短期的資料庫 `table`，這在客戶端重啟時會清空。

在 `db` 中儲存客戶端已經見過的節點（已經見過的定義是有收過正確 `pong` 訊息）。 `db` 並沒有容量的限制。每個 `db` 的記錄包含節點 ID 、IP 地址、TCP 端口、UDP 端口、上次送 `ping` 的時間、上次收過 `pong` 的時間，以及該節點無法回應 `findnode` 的次數。一個節點的「年紀」是上次收到 `pong` 的時間至今。每個小時客戶端會清理掉 `db` 中年紀超過 1 天的節點。

在 `table` 中，包含 256 個水桶，每個水桶可以包含 k=16 筆記錄。每個記錄記載節點 ID 、IP 地址、TCP 端口、UDP 端口。每筆記錄以加入桶子的順序排列，當客戶端發現一個新節點，對應到一個已滿的桶子，客戶端會去 `ping` 桶子中最後一個節點（最老的）。節點會被移出 `table` 如果無法回應 `findnode` 至多四次。

(TBD)

### Populating the data structures

### Seeding

### Selecting peers

### 子協定 Sub protocol 


## 攻擊模型

{{"cryptoeprint:2018:236"|cite}} 是個很好的開始。除了有些相關比特幣的點對點網路攻擊文獻回顧，內文提到的日蝕攻擊也有許多衍生的攻擊方式。

（TBD）

## 參考資料

{% references %}

{% endreferences %}